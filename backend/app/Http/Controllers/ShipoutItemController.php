<?php

namespace App\Http\Controllers;

use Illuminate\Support\Facades\DB;
use App\Models\Shipout_items;
use App\Models\Customer;
use App\Models\Product_type;
use App\Models\Invoice_master;
use App\Models\Invoice_detail;
use App\Models\Inventory_allocation;

use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Mail;
use App\Events\ShipmentEvent;
use App\Services\AutoGenerated;

class ShipoutItemController extends Controller{
    
    public function getShipoutItemList(Request $request){
        $perPage = (int) $request->input('per_page', 15);
        $search = $request->input('search', '');
        $dateFrom = $request->input('date_from');
        $dateTo = $request->input('date_to');
        $categoryDates = $request->input('category_dates');

        // Build search condition closure to reuse in both subquery and main query
        $applySearch = function ($q) use ($search) {
            if ($search) {
                $q->where(function ($subQ) use ($search) {
                    // Direct column searches (faster)
                    $subQ->where('tracking', 'like', "%{$search}%")
                        ->orWhere('invoice_no', 'like', "%{$search}%")
                        ->orWhere('shipped_packages', 'like', "%{$search}%")
                        // Relationship searches
                        ->orWhereHas('customer', function ($customerQ) use ($search) {
                            $customerQ->where('customer_code', 'like', "%{$search}%")
                                ->orWhere('account_name_en', 'like', "%{$search}%")
                                ->orWhere('account_name_cn', 'like', "%{$search}%");
                        })
                        ->orWhereHas('product', function ($productQ) use ($search) {
                            $productQ->where('product_code', 'like', "%{$search}%")
                                ->orWhere('product_title_en', 'like', "%{$search}%")
                                ->orWhere('product_title_cn', 'like', "%{$search}%");
                        })
                        ->orWhereHas('courier', function ($courierQ) use ($search) {
                            $courierQ->where('courier_en', 'like', "%{$search}%")
                                ->orWhere('courier_cn', 'like', "%{$search}%");
                        })
                        ->orWhereHas('shippingStatus', function ($statusQ) use ($search) {
                            $statusQ->where('shipping_stat_en', 'like', "%{$search}%")
                                ->orWhere('shipping_stat_cn', 'like', "%{$search}%");
                        });
                });
            }
        };

        // Apply date filter to subquery
        $subQueryBuilder = Shipout_items::query();
        if ($categoryDates === 'Date' && $dateFrom && $dateTo) {
            $subQueryBuilder->whereBetween('date', [$dateFrom, $dateTo]);
        }
        
        // Apply search to subquery
        $applySearch($subQueryBuilder);
        
        // Optimized subquery with filters applied
        $subQuery = $subQueryBuilder->selectRaw('MAX(id) as id')
            ->groupBy('customer_id','courier_id', 'tracking', 'shipped_packages', 'date', 'status');

        // Build main query with eager loading
        $query = Shipout_items::query()
            ->with([
                'customer:id,customer_code,account_name_en,account_name_cn,email_address',
                'product:id,product_code,product_title_en,product_title_cn',
                'courier:id,courier_en,courier_cn',
                'shippingStatus:id,shipping_stat_en,shipping_stat_cn'
            ])
            ->whereIn('id', $subQuery)
            ->orderByRaw("FIELD(status, 1, 2, 3)")
            ->orderByDesc('date')
            ->orderByDesc('id');

        // Execute query
        $result = $perPage === -1 ? $query->get() : $query->paginate($perPage);

        // Collect all invoice numbers for batch loading details
        $invoiceNos = $result instanceof \Illuminate\Pagination\LengthAwarePaginator 
            ? $result->getCollection()->pluck('invoice_no')->unique()->toArray()
            : $result->pluck('invoice_no')->unique()->toArray();

        // Batch load all details at once (N+1 query optimization)
        $allDetails = Shipout_items::with(['product:id,product_code,product_title_en,product_title_cn'])
            ->whereIn('invoice_no', $invoiceNos)->get()
            ->groupBy(function ($item) {
                return $item->invoice_no . '|' . $item->date;
            });

        // Transform function with pre-loaded details
        $transform = function ($item, $index) use ($allDetails, $result, $perPage) {
            $key = $item->invoice_no . '|' . $item->date;
            $details = ($allDetails[$key] ?? collect())->map(function ($detail) {
                return [
                    'id' => $detail->id ?? 0,
                    'product_code' => $detail->product->product_code ?? '',
                    'product_title_en' => $detail->product->product_title_en ?? '',
                    'product_title_cn' => $detail->product->product_title_cn ?? '',
                    'remarks' => $detail->remarks ?? '',
                    'date' => $detail->date ?? '',
                    'invoice_no' => $detail->invoice_no ?? '',
                    'qty' => $detail->qty ?? 0,
                ];
            });
            $ids = $details->pluck('id')->unique()->implode(',');
            $invoice_no = $details->pluck('invoice_no')->unique()->implode(',');
            // Calculate global index for pagination
            $page = $result instanceof \Illuminate\Pagination\LengthAwarePaginator ? $result->currentPage() : 1;
            $perPage = $perPage === -1 ? $result->count() : $perPage;
            $globalIndex = ($page - 1) * $perPage + $index + 1;

            $account_name_en = $item->customer->account_name_en ?? '';
            $account_name_cn = $item->customer->account_name_cn ?? '';
            $account_name_cn = ($account_name_cn === '' ? $account_name_en : $account_name_cn);

            $randomNumber = rand(10000, 99999);

            $is_display_mail = "";

            if($item->customer->email_address != ''){
                if($item->tracking != ''){
                    if($item->is_email_sent === 1){
                        $is_display_mail = "Sent";
                    }
                    else{
                        $is_display_mail = "Mail";
                    }
                }
            }
            return [
                'id' => $item->id,
                'table_ids' => $ids,
                'index_id' => $globalIndex + $randomNumber,
                'courier_id' => $item->courier_id,
                'tracking' => $item->tracking,
                'shipped_packages' => $item->shipped_packages,
                'date' => $item->date ? Carbon::parse($item->date)->format('M d Y') : '',
                'status' => $item->status,
                'invoice_no' => $invoice_no,
                'is_email_sent' => $item->is_email_sent,
                'customer_id' => $item->customer->id ?? 0,
                'customer_code' => $item->customer->customer_code ?? '',
                'language' => $item->customer->language ?? '',
                'account_name_en' => $account_name_en ?? '',
                'account_name_cn' => $account_name_cn ?? '',
                'email_address' => $item->customer->email_address ?? '',
                'courier_en' => $item->courier->courier_en ?? '',
                'courier_cn' => $item->courier->courier_cn ?? '',
                'shipping_stat_en' => $item->shippingStatus->shipping_stat_en ?? '',
                'shipping_stat_cn' => $item->shippingStatus->shipping_stat_cn ?? '',
                'is_display_mail' => $is_display_mail,
                'details' => $details,
            ];
        };

        // Apply transformation
        if ($perPage === -1) {
            $data = $result->map($transform);
            $response = [
                'current_page' => 1,
                'data' => $data,
                'last_page' => 1,
                'per_page' => $data->count(),
                'total' => $data->count(),
            ];
        } else {
            $data = $result->getCollection()->map($transform);
            $result->setCollection($data);
            $response = $result;
        }

        return response()->json([
            'success' => true,
            'message' => 'success',
            'list' => $response,
        ]);
    }
    public function getPreparedShipment(Request $request) {
        $perPage = (int) $request->input('per_page', 15);
        $search = $request->input('search', '');

        // Start with the query builder, not the collection
        $query = Invoice_master::with(['invoiceDetails.product', 'shippingStat', 'customer'])
            ->whereHas('invoiceDetails', function ($query) {
                $query->whereNotNull('product_id')->whereRaw('qty - on_ship_out_qty > 0');
            })
            ->orderByDesc('id');

        if ($search) {
            $query->where(function ($q) use ($search) {
                $q->where('invoice_no', 'like', "%{$search}%")
                    ->orWhereHas('customer', function ($q) use ($search) {
                        $q->where('customer_code', 'like', "%{$search}%")
                            ->orWhere('account_name_en', 'like', "%{$search}%")
                            ->orWhere('account_name_cn', 'like', "%{$search}%");
                    })
                    ->orWhereHas('invoiceDetails.product', function ($q) use ($search) {
                        $q->where('product_code', 'like', "%{$search}%")
                            ->orWhere('product_title_en', 'like', "%{$search}%")
                            ->orWhere('product_title_cn', 'like', "%{$search}%");
                    });
            });
        }
        // Handle pagination logic
        $result = $perPage === -1 ? $query->get() : $query->paginate($perPage);
        // Example transform (you can customize this)

        $transform = function ($invoice) {
            // Fallback to account_name_en if account_name_cn is empty
            $account_name_en = $invoice->customer->account_name_en ?? '';
            $account_name_cn = $invoice->customer->account_name_cn ?? '';
            $account_name_cn = ($account_name_cn === '' ? $account_name_en : $account_name_cn);

            $allDetails = $this->doDisplayDetails($invoice->invoice_no);

            return [
                'id' => $invoice->id,
                'index_id' => $invoice->id,  // Redundant, but if needed to maintain consistency
                'invoice_no' => $invoice->invoice_no,
                'customer_code' => $invoice->customer->customer_code ?? '',
                'account_name_en' => $account_name_en,
                'account_name_cn' => $account_name_cn,
                'shipping_stat_en' => $invoice->shippingStat->shipping_stat_en ?? '',
                'shipping_stat_cn' => $invoice->shippingStat->shipping_stat_cn ?? '',
                'qty' => $invoice->invoiceDetails->sum('qty'),  // Sum the quantity from the invoice details
                'details' => $allDetails,  // Include the details of the invoice items
            ];
        };


        // Apply transformation
        if ($perPage === -1) {
            $data = $result->map($transform);
            $response = [
                'current_page' => 1,
                'data' => $data,
                'last_page' => 1,
                'per_page' => $data->count(),
                'total' => $data->count(),
            ];
        } else {
            $data = $result->getCollection()->map($transform);
            $result->setCollection($data);
            $response = $result;
        }

        return response()->json([
            'success' => true,
            'message' => 'success',
            'list' => $response,
        ]);
    }
    public function doDisplayDetails($invoice_no){
        // Fetch invoice details with related product data
        $details = Invoice_detail::with(['product:id,product_code,product_title_en,product_title_cn'])
            ->where('invoice_no', $invoice_no)
            ->whereNotNull('product_id')
            ->get()
            ->map(function ($detail) {
                // Calculate the custom fields based on existing data
                $onShipQtyNew = $detail->on_ship_out_qty - $detail->shipped_qty;
                $remainingQty = $detail->qty - ($onShipQtyNew + $detail->shipped_qty);
                $readyQty = $detail->qty - ($onShipQtyNew + $detail->shipped_qty);

                // Prepare the final structure for each invoice detail
                return [
                    'id' => $detail->id,
                    'index_id' => $detail->id,
                    'customer_id' => $detail->customer_id,
                    'qty' => $detail->qty,
                    'on_ship_out_qty' => $detail->on_ship_out_qty,
                    'shipped_qty' => $detail->shipped_qty,
                    'invoice_no' => $detail->invoice_no,
                    'remarks' => '',
                    'is_checked' => 0,
                    'product_id' => $detail->product->id ?? 0,
                    'product_code' => $detail->product->product_code ?? '',
                    'product_title_en' => $detail->product->product_title_en ?? '',
                    'product_title_cn' => $detail->product->product_title_cn ?? '',
                    'on_ship_qty_new' => $onShipQtyNew,
                    'remaining_qty' => $remainingQty,
                    'ready_qty' => $readyQty,
                    'ready' => $remainingQty,
                ];
            });

        // Filter out rows where the remaining quantity is less than or equal to 0
        $filteredDetails = $details->filter(function ($item) {
            return $item['remaining_qty'] > 0;
        });

        // Return the filtered result
        return $filteredDetails->values();  // Reset keys for a clean result
    }
    public function deleteShipOut(Request $request){
        DB::beginTransaction();

        try {
            foreach ($request->details as $list) {
                if (is_string($list)) {
                    $list = json_decode($list, true);

                    $invoice_no = $list['invoice_no'] ?? null;
                    $table_ids = $list['table_ids'] ?? null;

                    if (empty($invoice_no) || empty($table_ids)) {
                        continue;
                    }

                    $tableIdsArray = array_map('trim', explode(',', $table_ids));

                    foreach ($tableIdsArray as $id) {
                        $item = Shipout_items::find((int) $id);
                        if ($item) {
                            $item->delete();
                        }
                    }

                    $globalController = new GlobalController();
                    $globalController->logAction(
                        'Shipout Items', 't_shipout_items',
                        'delete',
                        'Invoice No : ' . $invoice_no
                    );
                }
            }

            event(new ShipmentEvent('delete'));

            DB::commit();

            return response()->json([
                'token' => 'Success', 
                'message' => 'Record has been Deleted'
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json([
                'token' => 'Error', 
                'message' => $e->getMessage()
            ]);
        }
    }
    public function updateShipoutItems(Request $request){
        $data = $request->all();

        DB::beginTransaction();

        try {

            foreach($data as $list){
                $table_ids = $list['table_ids'];
                $courier_id = $list['courier_id'];
                $tracking = $list['tracking'];
                $shipped_packages = $list['shipped_packages'];
                $invoice_no = $list['invoice_no'];
                $date = $list['date'];
                $date = Carbon::parse($date)->format('Y-m-d');
                $status = 2;
                $tableIdsArray = array_map('trim', explode(',', $table_ids));
                foreach ($tableIdsArray as $id) {
                    $item = Shipout_items::find((int) $id);
                    if ($item) {
                        $item->on_update_shipout_items = 1;
                        $item->courier_id = $courier_id;
                        $item->tracking = $tracking;
                        $item->shipped_packages = $shipped_packages;
                        $item->status = $status;
                        $item->date = $date;
                        $item->save();
                        $this->updateShipmentStatus($status,$item->invoice_detail_id,$item->invoice_no,$item->product_id);
                    }
                }

                $globalController = new GlobalController();
                $globalController->logAction(
                    'Shipout Items', 't_shipout_items',
                    'update',
                    'Invoice No : ' . $invoice_no
                );
            }

            event(new ShipmentEvent('update'));

            DB::commit();

            return response()->json([
                'token' => 'Success', 
                'message' => 'Record Successfully updated'
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json([
                'token' => 'Error', 
                'message' => $e->getMessage()
            ]);
        }
    }
    public function sendEmailOnShipOut(Request $request){
        $data = $request->all();
        DB::beginTransaction();

        try {

            $newArray = array();
            foreach($data as $list){
                $table_ids = $list['table_ids'];
                $invoice_no = $list['invoice_no'];
                $date = $list['date'];
                $tracking = $list['tracking'];
                $customer_name_en = $list['account_name_en'];
                $customer_name_cn = $list['account_name_cn'];
                $customer_id = $list['customer_id'];
                $courier_en = $list['courier_en'];
                $courier_cn = $list['courier_cn'];
                $email_address = $list['email_address'];

                $language = "";
                $billing_address_en = "";
                $billing_address_cn = "";
                $billing_tel_no = "";
                $country_en = "";
                $country_cn = "";

                $Customer = Customer::with(['countryList:id,country_en,country_cn'])->find($customer_id);
                if($Customer){
                    $billing_address_en = $Customer->billing_address_en;
                    $billing_address_cn = $Customer->billing_address_cn;
                    $billing_tel_no = $Customer->billing_tel_no;
                    $language = $Customer->language;
                    $country_en = $Customer->countryList->country_en ?? '';
                    $country_cn = $Customer->countryList->country_cn ?? '';
                }

                $tableIdsArray = array_map('trim', explode(',', $table_ids));
                $shipoutItems = Shipout_items::with(['product:id,product_code,product_title_en,product_title_cn,product_type_id'])->whereIn('id', $tableIdsArray)
                    ->get()
                    ->map(function($item) {

                        $type = Product_type::find($item->product->product_type_id);
                        $product_type_en = $type->product_type_en ?? "";
                        $product_type_cn = $type->product_type_cn ?? "";

                        return [
                            'id' => $item->id,
                            'product_id' => $item->product->id ?? '',
                            'product_type_id' => $item->product->product_type_id ?? '',
                            'product_code' => $item->product->product_code ?? '',
                            'product_title_en' => $item->product->product_title_en ?? '',
                            'product_title_cn' => $item->product->product_title_cn ?? '',
                            'product_type_en' => $product_type_en,
                            'product_type_cn' => $product_type_cn,
                            'qty' => $item->qty ?? '',
                            'tracking' => $item->tracking ?? '',
                        ];
                    });

                $newArray[] = [
                    'invoice_no' => $invoice_no, 
                    'date' => $date, 
                    'tracking' => $tracking, 
                    'customer_name_en' => $customer_name_en, 
                    'customer_name_cn' => $customer_name_cn, 
                    'billing_address_en' => $billing_address_en, 
                    'billing_address_cn' => $billing_address_cn, 
                    'billing_tel_no' => $billing_tel_no, 
                    'country_en' => $country_en, 
                    'country_cn' => $country_cn,
                    'courier_en' => $courier_en,
                    'courier_cn' => $courier_cn,
                    'language' => $language,
                    'email_address' => $email_address,
                    'shipoutItems' => $shipoutItems, 
                ];
            }
            if(count($newArray) > 0){
                foreach($newArray  as $item){
                    $language = $item['language'];
                    $TrackingNumber = $item['tracking'];
                    $Courier = ($language === "EN" ? $item['courier_en'] : $item['courier_cn']);
                    $CustomerName = ($language === "EN" ? $item['courier_en'] : $item['courier_cn']);
                    $CustomerName = ($language === "EN" ? $item['customer_name_en'] : $item['customer_name_cn']);
                    $BillingAddress = ($language === "EN" ? $item['billing_address_en'] : $item['billing_address_cn']);
                    $BillingTelNo = $item['billing_tel_no'];
                    $BillingCountry = ($language === "EN" ? $item['country_en'] : $item['country_cn']);
                    $OrderID = $item['invoice_no'];
                    $OrderDate = $item['date'];
                    $email_address = $item['email_address'];
                    $arrayResult = $item['shipoutItems'];
                    $baseUrl = env('APP_URL');
                    $APP_ENV = env('APP_ENV');

                    $mailContent = "";
                    $mailContent .= '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
                    <html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office">
                        <head>
                            <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
                            <meta http-equiv="X-UA-Compatible" content="IE=edge">
                            <meta name="format-detection" content="telephone=no">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title></title>
                            <style type="text/css" emogrify="no">
                                #outlook a {
                                    padding: 0;
                                }
                    
                                .ExternalClass {
                                    width: 100%;
                                }
                    
                                .ExternalClass,
                                .ExternalClass p,
                                .ExternalClass span,
                                .ExternalClass font,
                                .ExternalClass td,
                                .ExternalClass div {
                                    line-height: 100%;
                                }
                    
                                table td {
                                    border-collapse: collapse;
                                    mso-line-height-rule: exactly;
                                }
                    
                                .editable.image {
                                    font-size: 0 !important;
                                    line-height: 0 !important;
                                }
                    
                                .nl2go_preheader {
                                    display: none !important;
                                    mso-hide: all !important;
                                    mso-line-height-rule: exactly;
                                    visibility: hidden !important;
                                    line-height: 0px !important;
                                    font-size: 0px !important;
                                }
                    
                                body {
                                    width: 100% !important;
                                    -webkit-text-size-adjust: 100%;
                                    -ms-text-size-adjust: 100%;
                                    margin: 0;
                                    padding: 0;
                                }
                    
                                img {
                                    outline: none;
                                    text-decoration: none;
                                    -ms-interpolation-mode: bicubic;
                                }
                    
                                a img {
                                    border: none;
                                }
                    
                                table {
                                    border-collapse: collapse;
                                    mso-table-lspace: 0pt;
                                    mso-table-rspace: 0pt;
                                }
                    
                                th {
                                    font-weight: normal;
                                    text-align: left;
                                }
                    
                                *[class="gmail-fix"] {
                                    display: none !important;
                                }
                            </style>
                            <style type="text/css" emogrify="no">
                                @media (max-width: 600px) {
                                    .gmx-killpill {
                                        content: "\03D1";
                                    }
                                }
                            </style>
                            <style type="text/css" emogrify="no">
                                @media (max-width: 600px) {
                                    .gmx-killpill {
                                        content: "\03D1";
                                    }
                    
                                    .r0-o {
                                        border-style: solid !important;
                                        margin: 0 auto 0 auto !important;
                                        width: 100% !important
                                    }
                    
                                    .r1-i {
                                        background-color: transparent !important
                                    }
                    
                                    .r2-c {
                                        box-sizing: border-box !important;
                                        text-align: center !important;
                                        valign: top !important;
                                        width: 320px !important
                                    }
                    
                                    .r3-o {
                                        border-style: solid !important;
                                        margin: 0 auto 0 auto !important;
                                        width: 320px !important
                                    }
                    
                                    .r4-i {
                                        padding-bottom: 5px !important;
                                        padding-top: 5px !important
                                    }
                    
                                    .r5-c {
                                        box-sizing: border-box !important;
                                        display: block !important;
                                        valign: top !important;
                                        width: 100% !important
                                    }
                    
                                    .r6-o {
                                        border-style: solid !important;
                                        width: 100% !important
                                    }
                    
                                    .r7-i {
                                        padding-left: 10px !important;
                                        padding-right: 10px !important;
                                        padding-top: 20px !important;
                                        text-align: center !important
                                    }
                    
                                    .r8-i {
                                        background-color: #fff !important
                                    }
                    
                                    .r9-i {
                                        padding-bottom: 31px !important;
                                        padding-left: 10px !important;
                                        padding-right: 10px !important;
                                        padding-top: 31px !important
                                    }
                    
                                    .r10-o {
                                        border-style: solid !important;
                                        margin: 0 auto 0 auto !important;
                                        width: 165px !important
                                    }
                    
                                    .r11-c {
                                        box-sizing: border-box !important;
                                        text-align: center !important;
                                        valign: top !important;
                                        width: 100% !important
                                    }
                    
                                    .r12-i {
                                        background-color: #ffffff !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 76px !important
                                    }
                    
                                    .r13-o {
                                        border-style: solid !important;
                                        margin: 0 auto 0 0 !important;
                                        margin-bottom: 0px !important;
                                        margin-top: 0px !important;
                                        width: 100% !important
                                    }
                    
                                    .r14-i {
                                        text-align: left !important
                                    }
                    
                                    .r15-o {
                                        border-style: solid !important;
                                        margin: 0 auto 0 0 !important;
                                        width: 100% !important
                                    }
                    
                                    .r16-i {
                                        padding-top: 15px !important;
                                        text-align: left !important
                                    }
                    
                                    .r17-i {
                                        background-color: #ffffff !important;
                                        padding-bottom: 25px !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 25px !important
                                    }
                    
                                    .r18-i {
                                        padding-left: 0px !important;
                                        padding-right: 0px !important
                                    }
                    
                                    .r19-c {
                                        box-sizing: border-box !important;
                                        padding-top: 10px !important;
                                        text-align: left !important;
                                        valign: top !important;
                                        width: 100% !important
                                    }
                    
                                    .r20-c {
                                        box-sizing: border-box !important;
                                        padding: 0 !important;
                                        text-align: left !important;
                                        valign: top !important;
                                        width: 100% !important
                                    }
                    
                                    .r21-o {
                                        border-style: solid !important;
                                        margin: 0 auto 0 0 !important;
                                        margin-top: 40px !important;
                                        width: 100% !important
                                    }
                    
                                    .r22-i {
                                        padding: 0 !important;
                                        text-align: center !important
                                    }
                    
                                    .r23-r {
                                        background-color: #121212 !important;
                                        border-radius: 0px !important;
                                        border-width: 0px !important;
                                        box-sizing: border-box;
                                        height: initial !important;
                                        padding: 0 !important;
                                        padding-bottom: 14px !important;
                                        padding-left: 5px !important;
                                        padding-right: 5px !important;
                                        padding-top: 13px !important;
                                        text-align: center !important;
                                        width: 100% !important
                                    }
                    
                                    .r24-o {
                                        border-style: solid !important;
                                        margin: 0 auto 0 0 !important;
                                        margin-top: 20px !important;
                                        width: 100% !important
                                    }
                    
                                    .r25-r {
                                        background-color: #ffffff !important;
                                        border-color: #75ebef !important;
                                        border-radius: 0px !important;
                                        border-width: 2px !important;
                                        box-sizing: border-box;
                                        height: initial !important;
                                        padding: 0 !important;
                                        padding-bottom: 12px !important;
                                        padding-left: 5px !important;
                                        padding-right: 5px !important;
                                        padding-top: 12px !important;
                                        text-align: center !important;
                                        width: 100% !important
                                    }
                    
                                    .r26-o {
                                        border-style: solid !important;
                                        margin: 0 0 0 auto !important;
                                        width: 100% !important
                                    }
                    
                                    .r27-i {
                                        padding-top: 30px !important
                                    }
                    
                                    .r28-i {
                                        background-color: #404049 !important;
                                        padding-bottom: 30px !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 30px !important
                                    }
                    
                                    .r29-i {
                                        padding-top: 20px !important;
                                        text-align: left !important
                                    }
                    
                                    .r30-i {
                                        background-color: #ffffff !important;
                                        padding-left: 10px !important;
                                        padding-right: 10px !important;
                                        padding-top: 57px !important
                                    }
                    
                                    .r31-c {
                                        box-sizing: border-box !important;
                                        text-align: center !important;
                                        valign: top !important;
                                        width: 124px !important
                                    }
                    
                                    .r32-o {
                                        border-style: solid !important;
                                        margin: 0 auto 0 auto !important;
                                        width: 124px !important
                                    }
                    
                                    .r33-i {
                                        padding-top: 30px !important;
                                        text-align: center !important
                                    }
                    
                                    .r34-i {
                                        padding-top: 6px !important;
                                        text-align: center !important
                                    }
                    
                                    .r35-i {
                                        padding-top: 5px !important;
                                        text-align: center !important
                                    }
                    
                                    .r36-i {
                                        padding-top: 20px !important;
                                        text-align: center !important
                                    }
                    
                                    .r37-i {
                                        background-color: #ffffff !important;
                                        padding-left: 10px !important;
                                        padding-right: 10px !important;
                                        padding-top: 30px !important
                                    }
                    
                                    .r38-i {
                                        background-color: #ffffff !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 30px !important
                                    }
                    
                                    .r39-i {
                                        background-color: #ffffff !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 18px !important
                                    }
                    
                                    .r40-c {
                                        box-sizing: border-box !important;
                                        valign: top !important;
                                        width: 50% !important
                                    }
                    
                                    .r41-i {
                                        text-align: right !important
                                    }
                    
                                    .r42-i {
                                        background-color: #ffffff !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 11px !important
                                    }
                    
                                    .r43-i {
                                        background-color: #ffffff !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 9px !important
                                    }
                    
                                    .r44-i {
                                        background-color: #ffffff !important;
                                        padding-bottom: 55px !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 15px !important
                                    }
                    
                                    .r45-o {
                                        background-size: cover !important;
                                        border-style: solid !important;
                                        margin: 0 auto 0 auto !important;
                                        width: 100% !important
                                    }
                    
                                    .r46-i {
                                        background-color: #121212 !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 55px !important
                                    }
                    
                                    .r47-c {
                                        box-sizing: border-box !important;
                                        valign: top !important;
                                        width: 100% !important
                                    }
                    
                                    .r48-c {
                                        box-sizing: border-box !important;
                                        text-align: center !important;
                                        width: 100% !important
                                    }
                    
                                    .r49-c {
                                        box-sizing: border-box !important;
                                        width: 100% !important
                                    }
                    
                                    .r50-i {
                                        font-size: 0px !important;
                                        padding-left: 41px !important;
                                        padding-right: 41px !important
                                    }
                    
                                    .r51-c {
                                        box-sizing: border-box !important;
                                        width: 32px !important
                                    }
                    
                                    .r52-o {
                                        border-style: solid !important;
                                        margin-right: 20px !important;
                                        width: 32px !important
                                    }
                    
                                    .r53-i {
                                        background-color: #121212 !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 48px !important
                                    }
                    
                                    .r54-i {
                                        background-color: #121212 !important;
                                        padding-bottom: 45px !important;
                                        padding-left: 15px !important;
                                        padding-right: 15px !important;
                                        padding-top: 23px !important
                                    }
                    
                                    .r55-i {
                                        padding-top: 5px !important;
                                        text-align: left !important
                                    }
                    
                                    body {
                                        -webkit-text-size-adjust: none
                                    }
                    
                                    .nl2go-responsive-hide {
                                        display: none
                                    }
                    
                                    .nl2go-body-table {
                                        min-width: unset !important
                                    }
                    
                                    .mobshow {
                                        height: auto !important;
                                        overflow: visible !important;
                                        max-height: unset !important;
                                        visibility: visible !important;
                                        border: none !important
                                    }
                    
                                    .resp-table {
                                        display: inline-table !important
                                    }
                    
                                    .magic-resp {
                                        display: table-cell !important
                                    }
                                }
                            </style>
                            <style type="text/css" emogrify="no">
                                @import url("https://fonts.googleapis.com/css2?family=Montserrat");
                            </style>
                            <style type="text/css">
                                p,
                                h1,
                                h2,
                                h3,
                                h4,
                                ol,
                                ul,
                                li {
                                    margin: 0;
                                }
                    
                                a,
                                a:link {
                                    color: #007aff;
                                    text-decoration: none
                                }
                    
                                .nl2go-default-textstyle {
                                    color: #3b3f44;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 16px;
                                    line-height: 1.2;
                                    word-break: break-word
                                }
                    
                                .default-button {
                                    color: #ffffff;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 16px;
                                    font-style: normal;
                                    font-weight: normal;
                                    line-height: 1.15;
                                    text-decoration: none;
                                    word-break: break-word
                                }
                    
                                .sib_class_16_white_roboto {
                                    color: #FFFFFF;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 16px;
                                    word-break: break-word
                                }
                    
                                .sib_class_16_black {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 16px;
                                    word-break: break-word
                                }
                    
                                .sib_class_16_white {
                                    color: #ffffff;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 16px;
                                    word-break: break-word
                                }
                    
                                .sib_class_16_black_sb {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 16px;
                                    font-weight: 600;
                                    word-break: break-word
                                }
                    
                                .sib_class_16_black_b {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 16px;
                                    font-weight: 700;
                                    word-break: break-word
                                }
                    
                                .sib_class_18_black_sb {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 18px;
                                    font-weight: 600;
                                    word-break: break-word
                                }
                    
                                .sib_class_18_blue_sb {
                                    color: #75EBEF;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 18px;
                                    font-weight: 600;
                                    word-break: break-word
                                }
                    
                                .sib_class_20_black_roboto {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 20px;
                                    word-break: break-word
                                }
                    
                                .sib_class_20_black_b {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 20px;
                                    font-weight: 700;
                                    word-break: break-word
                                }
                    
                                .sib_class_20_black_b_ul {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 20px;
                                    font-weight: 700;
                                    text-decoration: underline;
                                    word-break: break-word
                                }
                    
                                .sib_class_20_white_b_ul {
                                    color: #ffffff;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 20px;
                                    font-weight: 700;
                                    text-decoration: underline;
                                    word-break: break-word
                                }
                    
                                .sib_class_24_black_b {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 24px;
                                    font-weight: 700;
                                    word-break: break-word
                                }
                    
                                .sib_class_30_black_sb {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 30px;
                                    font-weight: 600;
                                    word-break: break-word
                                }
                    
                                .default-heading1 {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 30px;
                                    word-break: break-word
                                }
                    
                                .default-heading2 {
                                    color: #ffffff;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 20px;
                                    word-break: break-word
                                }
                    
                                .default-heading3 {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 20px;
                                    word-break: break-word
                                }
                    
                                .default-heading4 {
                                    color: #000000;
                                    font-family: Montserrat, arial, helvetica, sans-serif;
                                    font-size: 18px;
                                    word-break: break-word
                                }
                    
                                a[x-apple-data-detectors] {
                                    color: inherit !important;
                                    text-decoration: inherit !important;
                                    font-size: inherit !important;
                                    font-family: inherit !important;
                                    font-weight: inherit !important;
                                    line-height: inherit !important;
                                }
                    
                                .no-show-for-you {
                                    border: none;
                                    display: none;
                                    float: none;
                                    font-size: 0;
                                    height: 0;
                                    line-height: 0;
                                    max-height: 0;
                                    mso-hide: all;
                                    overflow: hidden;
                                    table-layout: fixed;
                                    visibility: hidden;
                                    width: 0;
                                }
                            </style>
                            <style type="text/css">
                                a:link {
                                    color: #007aff;
                                    text-decoration: none;
                                }
                            </style>
                        </head>
                        <body bgcolor="#fff" text="#3b3f44" link="#007aff" yahoo="fix" style="background-color: #fff;">
                            <table cellspacing="0" cellpadding="0" border="0" role="presentation" class="nl2go-body-table" width="100%" style="background-color: #fff; width: 100%;">
                                <tr>
                                    <td>
                                        <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="800" align="center" class="r3-o" style="table-layout: fixed; width: 800px;">
                                            <tr>
                                                <td valign="top" class="r8-i" style="background-color: #fff;">
                                                    <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r0-o" style="table-layout: fixed; width: 100%;">
                                                        <tr>
                                                            <td class="r12-i" style="background-color: #ffffff; padding-left: 35px; padding-right: 35px; padding-top: 16px;">
                                                                <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                    <tr>
                                                                        <th width="100%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                            <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r0-o" style="table-layout: fixed; width: 100%;">
                                                                                <tr>
                                                                                    <td valign="top" class="r8-i">
                                                                                        <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="600" align="center" class="r3-o" style="table-layout: fixed; width: 600px;">
                                                                                            <tr>
                                                                                                <td class="r9-i" style="padding-bottom: 31px; padding-left: 10px; padding-right: 10px; padding-top: 31px;">
                                                                                                    <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                                                        <tr>
                                                                                                            <th width="100%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                                                                <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="265" align="center" class="r10-o" style="table-layout: fixed; width: 265px;">
                                                                                                                    <tr>
                                                                                                                        <td style="font-size: 0px; line-height: 0px;">
                                                                                                                            <img src="https://toyntoys.com/images/logo.png" width="265" border="0" style="display: block; width: 100%;">
                                                                                                                        </td>
                                                                                                                    </tr>
                                                                                                                </table>
                                                                                                            </th>
                                                                                                        </tr>
                                                                                                    </table>
                                                                                                </td>
                                                                                            </tr>
                                                                                        </table>
                                                                                    </td>
                                                                                </tr>
                                                                            </table>
                                                                            <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r13-o" style="table-layout: fixed; width: 100%;">
                                                                                <tr>
                                                                                    <td align="center" valign="top" class="r14-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; text-align: left;">
                                                                                        <div>
                                                                                            <h1 class="default-heading1" style="text-align: center;margin: 0; color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 30px; word-break: break-word;">Your Order has been Shipped Look for it!</h1>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                            </table>
                                                                        </th>
                                                                    </tr>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r0-o" style="table-layout: fixed; width: 100%;">
                                                        <tr>
                                                            <td class="r17-i" style="background-color: #ffffff; padding-bottom: 25px; padding-left: 35px; padding-right: 35px; padding-top: 25px;">
                                                                <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                    <tr>
                                                                        <th width="100%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                            <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" class="r6-o" style="table-layout: fixed; width: 100%;">
                                                                                <tr>
                                                                                    <td valign="top" class="r18-i">
                                                                                        <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                                            <tr>
                                                                                                <td class="r19-c nl2go-default-textstyle" align="center" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 10px; text-align: center; valign: top;">
                                                                                                    <div>
                                                                                                        <div class="sib_class_16_black_sb" style="color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; font-weight: 600; word-break: break-word;">Order ID : '.$OrderID.'</div>
                                                                                                    </div>
                                                                                                </td>
                                                                                            </tr>
                                                                                            <tr>
                                                                                                <td class="r19-c nl2go-default-textstyle" align="center" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 10px; text-align: center; valign: top;">
                                                                                                    <div>
                                                                                                        <div class="sib_class_16_black_sb" style="color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; font-weight: 600; word-break: break-word;">Order Date : '.$OrderDate.'</div>
                                                                                                    </div>
                                                                                                </td>
                                                                                            </tr>
                                                                                        </table>
                                                                                    </td>
                                                                                </tr>
                                                                            </table>
                                                                        </th>
                                                                    </tr>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r0-o" style="table-layout: fixed; width: 100%;">
                                                        <tr>
                                                            <td class="r28-i" style="background-color: #404049; padding-bottom: 30px; padding-left: 35px; padding-right: 35px; padding-top: 30px;">
                                                                <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                    <tr>
                                                                        <th width="100%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                            <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                <tr>
                                                                                    <td align="center" valign="top" class="r16-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 15px; text-align: left;">
                                                                                        <div>
                                                                                            <div class="sib_class_16_white" style="text-align:center;color: #fff; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word;">
                                                                                                <span style="margin-bottom:10px;font-weight:bold">Tracking No</span><br>
                                                                                            </div>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td align="center" valign="top" class="r16-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 15px; text-align: left;">
                                                                                        <div>
                                                                                            <div class="sib_class_16_white" style="text-align:center;color: #fff; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word;">
                                                                                                <span style="margin-bottom:10px;font-weight:normal">'.$TrackingNumber.'</span><br>
                                                                                            </div>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                                <tr>
                                                                                    <td align="center" valign="top" class="r16-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 15px; text-align: left;">
                                                                                        <div>
                                                                                            <div class="sib_class_16_white" style="text-align:center;color: #fff; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word;">
                                                                                                <span style="margin-bottom:10px;font-weight:normal">By : '.$Courier.'</span><br>
                                                                                            </div>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                            </table>
                                                                        </th>
                                                                    </tr>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r0-o" style="table-layout: fixed; width: 100%;">
                                                        <tbody><tr>
                                                            <td class="r28-i" style="padding-bottom: 30px; padding-left: 35px; padding-right: 35px; padding-top: 30px;">
                                                                <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                    <tbody><tr>
                                                                        <th width="100%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                            <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="left" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                <tbody><tr>
                                                                                    <td align="left" valign="top" class="r14-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; text-align: left;">
                                                                                        <div>
                                                                                            <h2 class="default-heading2" style="margin: 0; color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 20px; word-break: break-word;">
                                                                                                <u>Shipped to:</u>
                                                                                            </h2>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                            </tbody></table>
                                                                            <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="left" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                <tbody><tr>
                                                                                    <td align="left" valign="top" class="r16-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 15px; text-align: left;">
                                                                                        <div>
                                                                                            <div class="sib_class_16_white" style="color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word;">
                                                                                                '.$CustomerName.' <br> 
                                                                                                '.$BillingAddress.' <br> 
                                                                                                '.$BillingTelNo.' <br> 
                                                                                                '.$BillingCountry.'
                                                                                            </div>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                            </tbody></table>
                                                                        </th>
                                                                    </tr>
                                                                </tbody></table>
                                                            </td>
                                                        </tr>
                                                    </tbody></table>';
                                                    foreach($arrayResult as $list){
                                                        $mailContent .= '<table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r0-o" style="table-layout: fixed; width: 100%;">
                                                            <tr>
                                                                <td class="r30-i" style="background-color: #ffffff; padding-left: 35px; padding-right: 35px; padding-top: 30px;">
                                                                    <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                        <tr>
                                                                            <th width="25%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                                <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" class="r6-o" style="table-layout: fixed; width: 100%;">
                                                                                    <tr>
                                                                                        <td valign="top" class="r18-i">
                                                                                            <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                                                <tr>
                                                                                                    <td class="r31-c" align="left">
                                                                                                        <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="115" class="r32-o" style="table-layout: fixed; width: 115px;">
                                                                                                            <tr>
                                                                                                                <td style="font-size: 0px; line-height: 0px;">
                                                                                                                    <img src="'.$baseUrl.'/storage/products/thumbnail/'.$list['product_code'].'_thumbnail.webp" width="115" border="0" style="display: block; width: 100%;">
                                                                                                                </td>
                                                                                                            </tr>
                                                                                                        </table>
                                                                                                    </td>
                                                                                                </tr>
                                                                                            </table>
                                                                                        </td>
                                                                                    </tr>
                                                                                </table>
                                                                            </th>
                                                                            <th width="50%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                                <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="left" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                    <tr>
                                                                                        <td align="left" valign="top" class="r33-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; text-align: left;">
                                                                                            <div>
                                                                                                <h3 class="default-heading3" style="margin: 0; color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 20px; word-break: break-word;">
                                                                                                    <u>'.$list['product_title_en'].'</u>
                                                                                                </h3>
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                </table>
                                                                                <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="left" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                    <tr>
                                                                                        <td align="left" valign="top" class="r34-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 6px; text-align: left;">
                                                                                            <div>
                                                                                                <div class="sib_class_16_black" style="color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word;">
                                                                                                    '.$list['product_type_en'].'
                                                                                                </div>
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                </table>
                                                                                <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="left" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                    <tr>
                                                                                        <td align="left" valign="top" class="r35-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 5px; text-align: left;">
                                                                                            <div>
                                                                                                <div class="sib_class_16_black" style="color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word;">Product Code : </div>
                                                                                                <div class="sib_class_16_black_sb" style="color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; font-weight: 600; word-break: break-word;"> '.$list['product_code'].'</div>
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                </table>
                                                                                <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="left" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                    <tr>
                                                                                        <td align="left" valign="top" class="r34-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 6px; text-align: left;">
                                                                                            <div>
                                                                                                <div class="sib_class_16_black" style="color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word;">Quantity : '.$list['qty'].'</div>
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                </table>
                                                                            </th>
                                                                            <th width="8.33%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                                <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="left" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                    <tr>
                                                                                        <td align="left" valign="top" class="r36-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 57px; text-align: left;">
                                                                                            <div>
                                                                                                <div class="sib_class_18_black_sb" style="color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 18px; font-weight: 600; word-break: break-word;"></div>
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                </table>
                                                                            </th>
                                                                            <th width="16.67%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                                <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="left" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                    <tr>
                                                                                        <td align="right" valign="top" class="r36-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; line-height: 1.2; word-break: break-word; padding-top: 49px; text-align: right;">
                                                                                            <div>
                                                                                                <div class="sib_class_24_black_b" style="color: #000; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 24px; font-weight: 700; word-break: break-word;"></div>
                                                                                            </div>
                                                                                        </td>
                                                                                    </tr>
                                                                                </table>
                                                                            </th>
                                                                        </tr>
                                                                    </table>
                                                                </td>
                                                            </tr>
                                                        </table>';
                                                    }
                                                    $mailContent .= '
                                                    <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r0-o" style="table-layout: fixed; width: 100%;">
                                                        <tr>
                                                            <td class="r38-i" style="background-color: #ffffff; padding-left: 35px; padding-right: 35px; padding-top: 30px;">
                                                                <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                    <tr>
                                                                        <th width="100%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                            <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="730" align="center" class="r0-o" style="table-layout: fixed;">
                                                                                <tr>
                                                                                    <td class="" style="height: 2px;">
                                                                                        <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                                            <tr>
                                                                                                <td>
                                                                                                    <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation" height="2" style="border-top-style: solid; background-clip: border-box; border-top-color: #75ebef; border-top-width: 2px; font-size: 2px; line-height: 2px;">
                                                                                                        <tr>
                                                                                                            <td height="0" style="font-size: 0px; line-height: 0px;">­</td>
                                                                                                        </tr>
                                                                                                    </table>
                                                                                                </td>
                                                                                            </tr>
                                                                                        </table>
                                                                                    </td>
                                                                                </tr>
                                                                            </table>
                                                                        </th>
                                                                    </tr>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r0-o" style="table-layout: fixed; width: 100%;">
                                                        <tr>
                                                            <td class="r53-i" style="background-color: #121212; padding-left: 35px; padding-right: 35px; padding-top: 48px;padding-bottom: 28px;">
                                                                <table width="100%" cellspacing="0" cellpadding="0" border="0" role="presentation">
                                                                    <tr>
                                                                        <th width="100%" valign="top" class="r5-c" style="font-weight: normal;">
                                                                            <table cellspacing="0" cellpadding="0" border="0" role="presentation" width="100%" align="center" class="r15-o" style="table-layout: fixed; width: 100%;">
                                                                                <tr>
                                                                                    <td align="left" valign="top" class="r14-i nl2go-default-textstyle" style="color: #3b3f44; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word; line-height: 1.3; text-align: center;">
                                                                                        <div>
                                                                                            <div class="sib_class_16_white_roboto" style="color: #fff; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word;text-align:center">Toyntoys.com</div>
                                                                                            <div class="sib_class_16_white_roboto" style="color: #fff; font-family: Montserrat,arial,helvetica,sans-serif; font-size: 16px; word-break: break-word;text-align:center">All Rights Reserved '.date('Y').'</div>
                                                                                        </div>
                                                                                    </td>
                                                                                </tr>
                                                                            </table>
                                                                        </th>
                                                                    </tr>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </body>
                    </html>';

                    if($APP_ENV != 'local'){
                        $Subject = ($language === "EN" ? "Ship Out Items" : "发货");
                        Mail::send([], [], function ($message) use ($email_address, $CustomerName, $OrderID, $mailContent) {
                            $message->to($email_address)->subject("Ship Out Items")->html($mailContent);
                        });
                    }

                    Shipout_items::where('invoice_no', $invoice_no)
                        ->update([
                            'on_update_shipout_items' => 1,
                            'is_email_sent' => 1
                        ]);
                }

                event(new ShipmentEvent('update'));

                DB::commit();

                return response()->json([
                    'token' => 'Success', 
                    'message' => 'Mail Sent'
                ]);
            }

            return response()->json([
                'token' => 'Error', 
                'message' => 'No Record Found'
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json([
                'token' => 'Error', 
                'message' => $e->getMessage()
            ]);
        }
    }
    public function confirmShipment(Request $request){
        $data = $request->all();

        DB::beginTransaction();

        try {

            foreach($data as $list){
                
                $status = 1;
                $AutoGenerated = new AutoGenerated();
                $shipping_no = $AutoGenerated->getNextNo("shipping_no","SHP","t_shipout_items");

                $insertMaster = [
                    'shipping_no' => $shipping_no,
                    'customer_id' => $list['customer_id'],
                    'invoice_no' => $list['invoice_no'],
                    'status' => $status,
                    'remarks' => $list['remarks'],
                    'product_id' => $list['product_id'],
                    'qty' => $list['ready'],
                    'date' => date('Y-m-d'),
                    'invoice_detail_id' => $list['id'],
                    'is_from_prepare' => 1
                ];
                Shipout_items::create($insertMaster);

                $on_ship_out_qty = Shipout_items::where('invoice_detail_id', $list['id'])->sum('qty');

                if ($status == 2) {
                    $sumShippedQty = Shipout_items::where('invoice_detail_id', $list['id'])
                        ->where('shipping_no', $shipping_no)
                        ->sum('qty');

                    Invoice_detail::where('id', $list['id'])
                        ->update(['shipped_qty' => $sumShippedQty]);
                }

                Invoice_detail::where('id', $list['id'])
                    ->update(['on_ship_out_qty' => $on_ship_out_qty]);

                $this->updateInvoiceShippingStatus($list['invoice_no']);

                $globalController = new GlobalController();
                $globalController->logAction(
                    'Prepared Shipment', 't_shipout_items',
                    'insert',
                    'Invoice No : ' . $list['invoice_no'] . ' - ' . 'Product Code : ' . $list['product_code']
                );
            }

            event(new ShipmentEvent('insert'));

            DB::commit();

            return response()->json([
                'token' => 'Success', 
                'message' => 'Process Shipment Successfully Confirmed'
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json([
                'token' => 'Error', 
                'message' => $e->getMessage()
            ]);
        }
    }
    public function updateInvoiceShippingStatus($invoice_no){
        // Get total invoice quantity
        $totalQty = Invoice_detail::where('invoice_no', $invoice_no)
            ->where('product_type', 0)
            ->sum('qty');

        // Get total shipped quantity
        $totalShippedQty = Invoice_detail::where('invoice_no', $invoice_no)
            ->where('product_type', 0)
            ->sum('shipped_qty');

        // Fetch the master invoice record
        $invoice = Invoice_master::where('invoice_no', $invoice_no)->first();

        if ($invoice) {
            if ($totalQty == $totalShippedQty) {
                // Fully shipped
                $invoice->shipping_stat_id = 2;
            } elseif ($totalShippedQty == 0) {
                // Not shipped
                $invoice->shipping_stat_id = 1;
            } elseif ($totalShippedQty > 0 && $totalShippedQty < $totalQty) {
                // Partially shipped
                $invoice->shipping_stat_id = 3;
            }
            $invoice->cnt_ship = 1;
            $invoice->save();
        }
    }
    public function updateShipmentStatus($newStatus, $invoiceDetailId, $invoice_no, $product_id){
        // If NewStatus == 2, update ShippedQty
        if ($newStatus == 2) {
            $sumShippedQty = Shipout_items::where('invoice_detail_id', $invoiceDetailId)
                ->where('status', 2)
                ->sum('qty');

            Invoice_detail::where('id', $invoiceDetailId)
                ->update(['shipped_qty' => $sumShippedQty]);
        }

        // Update OnShipOutQty
        $onShipOutQty = Shipout_items::where('invoice_detail_id', $invoiceDetailId)->sum('qty');

        Invoice_detail::where('id', $invoiceDetailId)
            ->update(['on_ship_out_qty' => $onShipOutQty]);

        // Sum total quantity for invoice (only ProductType = 0)
        $invoiceTotalQty = Invoice_detail::where('invoice_no', $invoice_no)
            ->where('product_type', 0)
            ->sum('qty');

        // Sum total shipped quantity
        $invoiceTotalShippedQty = Invoice_detail::where('invoice_no', $invoice_no)
            ->where('product_type', 0)
            ->sum('shipped_qty');

        // Update invoice shipping status
        if ($invoiceTotalQty == $invoiceTotalShippedQty) {
            Invoice_master::where('invoice_no', $invoice_no)
                ->update(['shipping_stat_id' => 2]);
        } elseif ($invoiceTotalShippedQty == 0) {
            Invoice_master::where('invoice_no', $invoice_no)
                ->update(['shipping_stat_id' => 1]);
        } elseif ($invoiceTotalShippedQty > 0 && $invoiceTotalShippedQty < $invoiceTotalQty) {
            Invoice_master::where('invoice_no', $invoice_no)
                ->update(['shipping_stat_id' => 3]);
        }
        // Update inventory allocation shipping status
        Inventory_allocation::where('invoice_no', $invoice_no)
            ->where('product_id', $product_id)
            ->update(['shipping_stat_id' => $newStatus]);
    }
}
